(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{290:function(s,t,a){"use strict";a.r(t);var e=a(14),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"frontmatter-title"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#frontmatter-title"}},[s._v("#")]),s._v(" "+s._s(s.$frontmatter.title))]),s._v(" "),a("p"),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#简介"}},[s._v("简介")])]),a("li",[a("a",{attrs:{href:"#原理"}},[s._v("原理")])]),a("li",[a("a",{attrs:{href:"#编译安装"}},[s._v("编译安装")])]),a("li",[a("a",{attrs:{href:"#测试"}},[s._v("测试")])])])]),a("p"),s._v(" "),a("h2",{attrs:{id:"简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[s._v("#")]),s._v(" 简介")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/etcd-carry/etcd-carry",target:"_blank",rel:"noopener noreferrer"}},[s._v("etcd-carry"),a("OutboundLink")],1),s._v("是由GO语言编写的一款实时同步工具，用户可以自定义同步规则，etcd-carry将符合规则的K8s集群资源实时同步到备用K8s集群。")]),s._v(" "),a("p",[s._v("通过etcd-carry同步主k8s集群的数据到备k8s集群etcd，方便主k8s集群出问题时快速切到备k8s集群。")]),s._v(" "),a("p",[s._v("etcd-carry可以通过规则指定K8s集群资源的同步顺序，并且支持按命名空间、标签选择器、资源specification中的字段、GVK等多种同步规则。")]),s._v(" "),a("h2",{attrs:{id:"原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#原理"}},[s._v("#")]),s._v(" 原理")]),s._v(" "),a("p",[s._v("自定义同步规则后，通过etcd range读接口从主集群遍历K8s集群资源，并将符合规则的K8s集群资源写入目的etcd，此过程相当于一次全量同步。")]),s._v(" "),a("p",[s._v("随后通过 etcd watch 接口指定range读接口返回的revision，监听从此revision后的所有变更事件。当主etcd中的K8s资源发生任何key-value变更时，etcd-carry会收到相应事件通知，会实时将符合规则的数据写入备用etcd集群，该同步延迟是非常低的。")]),s._v(" "),a("p",[s._v("若未指定同步规则，etcd-carry不会将主etcd集群中的任何数据同步到备用集群。当etcd-carry与主备集群任何一方发生网络中断时，同步流程将会暂停，直到网络连接恢复正常。")]),s._v(" "),a("p",[s._v("etcd-carry的同步是单向的，备用etcd集群上的任何变更都不会通过etcd-carry同步到主集群。目前只支持K8s集群资源的同步，但不支持Service资源的正确同步，不支持同步有状态服务在PV中的数据。")]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/architecture.png",alt:"img"}})]),s._v(" "),a("h2",{attrs:{id:"编译安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编译安装"}},[s._v("#")]),s._v(" 编译安装")]),s._v(" "),a("p",[s._v("下载源码")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/etcd-carry/etcd-carry.git\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("编译")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" etcd-carry\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("运行参数")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ ./bin/etcd-carry "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--help")]),s._v("\n\nA simple "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v(" line "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" etcd mirroring\n\nUsage:\n  etcd-carry "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("flags"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\nGeneric flags:\n\n      "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--debug")]),s._v("                "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" client-side debug logging\n      --mirror-rule string   Specify the rules to start mirroring "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/mirror/rules.yaml"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nEtcd flags:\n\n      --encryption-provider-config string   The "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" containing configuration "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" encryption providers to be used "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" storing secrets "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" etcd "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/mirror/secrets-encryption.yaml"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      --kube-prefix string                  the prefix to all kubernetes resources passed to etcd "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/registry"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      --max-txn-ops uint                    Maximum number of operations permitted "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" a transaction during syncing updates "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("128")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--rev")]),s._v(" int                             Specify the kv revision to start to mirror\n\nTransport flags:\n\n      --dest-cacert string                Verify certificates of TLS enabled secure servers using this CA bundle "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the destination cluster "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/kubernetes/dest/etcd/ca.crt"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      --dest-cert string                  Identify secure client using this TLS certificate "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the destination cluster "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/kubernetes/dest/etcd/server.crt"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      --dest-endpoints strings            List of etcd servers to connect with "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("scheme://ip:port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the destination cluster, comma separated\n      --dest-insecure-skip-tls-verify     skip server certificate verification "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CAUTION: this option should be enabled only "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" testing purposes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      --dest-insecure-transport           Disable transport security "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" client connections "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the destination cluster "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      --dest-key string                   Identify secure client using this TLS key "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the destination cluster "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/kubernetes/dest/etcd/server.key"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      --dial-timeout duration             dial "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" client connections "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default 2s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      --keepalive-time duration           keepalive "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" client connections "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default 2s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      --keepalive-timeout duration        keepalive "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" client connections "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default 6s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      --source-cacert string              verify certificates of TLS-enabled secure servers using this CA bundle "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/kubernetes/source/etcd/ca.crt"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      --source-cert string                identify secure client using this TLS certificate "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/kubernetes/source/etcd/server.crt"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      --source-endpoints strings          List of etcd servers to connect with "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("scheme://ip:port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", comma separated\n      --source-insecure-skip-tls-verify   skip server certificate verification "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CAUTION: this option should be enabled only "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" testing purposes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      --source-insecure-transport         disable transport security "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" client connections "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      --source-key string                 identify secure client using this TLS key "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/kubernetes/source/etcd/server.key"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br")])]),a("h2",{attrs:{id:"测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[s._v("#")]),s._v(" 测试")]),s._v(" "),a("p",[s._v("etcd-carry项目的"),a("a",{attrs:{href:"https://github.com/etcd-carry/etcd-carry/tree/master/deploy/examples",target:"_blank",rel:"noopener noreferrer"}},[s._v("deploy/examples"),a("OutboundLink")],1),s._v("目录下有示例，通过示例来演示同步效果。")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/etcd-carry/etcd-carry/blob/master/deploy/examples/rules.yaml",target:"_blank",rel:"noopener noreferrer"}},[s._v("rules.yaml"),a("OutboundLink")],1),s._v("文件里是同步规则：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("filters")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("sequential")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apiextensions.k8s.io\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apiextensions.k8s.io\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1beta1\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" CustomResourceDefinition\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Namespace\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labelSelectors")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchExpressions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test.io/namespace"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("kind\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("operator")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" In\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" unique\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" unit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("test\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("secondary")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Secret\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespaceSelectors")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchExpressions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test.io/namespace"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("kind\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("operator")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" In\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" unique\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("fieldSelectors")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchExpressions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" type\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("operator")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NotIn\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" kubernetes.io/service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("account"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("token\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("excludes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resource")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Secret\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" exclude"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("me"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("secret\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" unique\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ConfigMap\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" unit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("test\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labelSelectors")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchExpressions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test.io/namespace"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("kind\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("operator")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Exists\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br")])]),a("p",[s._v("filters.sequential配置的是需要优先按顺序同步的K8s资源。按照规则，这部分的资源会被优先同步：")]),s._v(" "),a("ul",[a("li",[s._v("首先，同步主K8s集群中所有的CRD资源到备集群；")]),s._v(" "),a("li",[s._v("其次，同步带有"),a("code",[s._v("test.io/namespace-kind:unique")]),s._v("或"),a("code",[s._v("test.io/namespace-kind:unit-test")]),s._v("标签的Namespace资源。")])]),s._v(" "),a("p",[s._v("filters.secondary配置的是无优先级要求的资源，这部分资源只有等filters.sequential全部同步完成后才开始进行。按照规则，会有以下资源将会被同步：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("type")]),s._v("不为"),a("code",[s._v("kubernetes.io/service-account-token")]),s._v("，且所属的"),a("code",[s._v("namespace")]),s._v("必须带有"),a("code",[s._v("test.io/namespace-kind:unique")]),s._v("标签的所有Secret资源，"),a("code",[s._v("unique")]),s._v("命名空间下名为"),a("code",[s._v("exclude-me-secret")]),s._v("的Secret资源除外；")]),s._v(" "),a("li",[a("code",[s._v("unit-test")]),s._v("命名空间下带有"),a("code",[s._v("test.io/namespace-kind")]),s._v("标签的ConfigMap资源。")])]),s._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/etcd-carry/etcd-carry/blob/master/deploy/examples/secrets-encryption.yaml",target:"_blank",rel:"noopener noreferrer"}},[s._v("secrets-encryption.yaml"),a("OutboundLink")],1),s._v("文件是kube-apiserver组件对需要加密存储的资源的加密信息，由kube-apiserver的"),a("code",[s._v("--encryption-provider-config")]),s._v("启动参数指定。")]),s._v(" "),a("p",[s._v("比如，我是在备K8s集群的master节点上运行etcd-carry，首先将主集群etcd组件的证书密钥拷贝到本地/etc/etcd-carry/source/目录下，命令如下：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ ./bin/etcd-carry --master-cacert"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/etcd-carry/source/ca.crt --master-cert"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/etcd-carry/source/server.crt --master-key"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/etcd-carry/source/server.key --master-endpoints"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.20")]),s._v(".144.29:2379 --slave-cacert"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/etcd/ca.crt --slave-cert"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/etcd/server.crt --slave-key"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/etcd/server.key --slave-endpoints"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".180.130:2379 --encryption-provider-config"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./deploy/examples/secrets-encryption.yaml --mirror-rule"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./deploy/examples/rules.yaml\n\nprobe ok"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\ncontext is stopping"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nstart to replay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("watch")]),s._v(" is stopping"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Sequential"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: apiextensions.k8s.io/v1beta1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CustomResourceDefinition Name: bgpconfigurations.crd.projectcalico.org Namespace:  Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Sequential"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: apiextensions.k8s.io/v1beta1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CustomResourceDefinition Name: bgppeers.crd.projectcalico.org Namespace:  Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Sequential"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: apiextensions.k8s.io/v1beta1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CustomResourceDefinition Name: blockaffinities.crd.projectcalico.org Namespace:  Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Sequential"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: apiextensions.k8s.io/v1beta1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CustomResourceDefinition Name: clusterinformations.crd.projectcalico.org Namespace:  Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Sequential"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: apiextensions.k8s.io/v1beta1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CustomResourceDefinition Name: felixconfigurations.crd.projectcalico.org Namespace:  Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Sequential"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: apiextensions.k8s.io/v1beta1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CustomResourceDefinition Name: globalnetworkpolicies.crd.projectcalico.org Namespace:  Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Sequential"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: apiextensions.k8s.io/v1beta1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CustomResourceDefinition Name: globalnetworksets.crd.projectcalico.org Namespace:  Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Sequential"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: apiextensions.k8s.io/v1beta1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CustomResourceDefinition Name: hostendpoints.crd.projectcalico.org Namespace:  Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Sequential"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: apiextensions.k8s.io/v1beta1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CustomResourceDefinition Name: ipamblocks.crd.projectcalico.org Namespace:  Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Sequential"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: apiextensions.k8s.io/v1beta1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CustomResourceDefinition Name: ipamconfigs.crd.projectcalico.org Namespace:  Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Sequential"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: apiextensions.k8s.io/v1beta1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CustomResourceDefinition Name: ipamhandles.crd.projectcalico.org Namespace:  Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Sequential"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: apiextensions.k8s.io/v1beta1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CustomResourceDefinition Name: ippools.crd.projectcalico.org Namespace:  Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Sequential"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: apiextensions.k8s.io/v1beta1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CustomResourceDefinition Name: kubecontrollersconfigurations.crd.projectcalico.org Namespace:  Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Sequential"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: apiextensions.k8s.io/v1beta1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CustomResourceDefinition Name: networkpolicies.crd.projectcalico.org Namespace:  Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Sequential"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: apiextensions.k8s.io/v1beta1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CustomResourceDefinition Name: networksets.crd.projectcalico.org Namespace:  Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Sequential"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: apiextensions.k8s.io/v1beta1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CustomResourceDefinition Name: servicemonitors.monitoring.coreos.com Namespace:  Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nKey: /registry/apiextensions.k8s.io/customresourcedefinitions/, Matched: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(", Filtered: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("\nPUT /registry/apiextensions.k8s.io/customresourcedefinitions/bgpconfigurations.crd.projectcalico.org\nPUT /registry/apiextensions.k8s.io/customresourcedefinitions/bgppeers.crd.projectcalico.org\nPUT /registry/apiextensions.k8s.io/customresourcedefinitions/blockaffinities.crd.projectcalico.org\nPUT /registry/apiextensions.k8s.io/customresourcedefinitions/clusterinformations.crd.projectcalico.org\nPUT /registry/apiextensions.k8s.io/customresourcedefinitions/felixconfigurations.crd.projectcalico.org\nPUT /registry/apiextensions.k8s.io/customresourcedefinitions/globalnetworkpolicies.crd.projectcalico.org\nPUT /registry/apiextensions.k8s.io/customresourcedefinitions/globalnetworksets.crd.projectcalico.org\nKey: /registry/namespaces/, Matched: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(", Filtered: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nPUT /registry/apiextensions.k8s.io/customresourcedefinitions/hostendpoints.crd.projectcalico.org\nPUT /registry/apiextensions.k8s.io/customresourcedefinitions/ipamblocks.crd.projectcalico.org\nPUT /registry/apiextensions.k8s.io/customresourcedefinitions/ipamconfigs.crd.projectcalico.org\nPUT /registry/apiextensions.k8s.io/customresourcedefinitions/ipamhandles.crd.projectcalico.org\nPUT /registry/apiextensions.k8s.io/customresourcedefinitions/ippools.crd.projectcalico.org\nPUT /registry/apiextensions.k8s.io/customresourcedefinitions/kubecontrollersconfigurations.crd.projectcalico.org\nPUT /registry/apiextensions.k8s.io/customresourcedefinitions/networkpolicies.crd.projectcalico.org\nPUT /registry/apiextensions.k8s.io/customresourcedefinitions/networksets.crd.projectcalico.org\nPUT /registry/apiextensions.k8s.io/customresourcedefinitions/servicemonitors.monitoring.coreos.com\nKey: /registry/, Matched: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("496")]),s._v(", Filtered: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nNo "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v(" keys matched:  /registry/ "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("496")]),s._v("\nStart to "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("watch")]),s._v(" updates from revision "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3852180")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br")])]),a("p",[s._v("从输出的调试信息中可以看到，此时以及将将主K8s集群上的所有CRD同步到备集群了。")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/etcd-carry/etcd-carry/tree/master/deploy/examples/kube",target:"_blank",rel:"noopener noreferrer"}},[s._v("kube"),a("OutboundLink")],1),s._v("目录下面是待同步的测试资源，在主K8s集群的master节点上通过"),a("code",[s._v("kubectl apply")]),s._v("命令来创建待同步的测试资源对象。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" deploy/examples/kube/\nconfigmap/influxdb1 created\nconfigmap/influxdb2 created\nnamespace/unique unchanged\nnamespace/unit-test unchanged\nsecret/influxdb unchanged\nsecret/mysql unchanged\nsecret/exclude-me-secret unchanged\n\n$ kubectl get cm "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-nunique")]),s._v("\nNAME        DATA   AGE\ninfluxdb2   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("      2m47s\n$ kubectl get secret "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-nunique")]),s._v("\nNAME                  TYPE                                  DATA   AGE\ndefault-token-rf5xl   kubernetes.io/service-account-token   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("      2m57s\nexclude-me-secret     Opaque                                "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("      2m57s\ninfluxdb              Opaque                                "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("      2m57s\n$ kubectl get cm -nunit-test\nNAME        DATA   AGE\ninfluxdb1   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("      3m\n$ kubectl get secret -nunit-test\nNAME                  TYPE                                  DATA   AGE\ndefault-token-lvkwj   kubernetes.io/service-account-token   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("      3m11s\nmysql                 Opaque                                "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("      3m11s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("p",[s._v("此时，从etcd-carry输出的调试信息中可以看到有资源同步过来了：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Sequential"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: /v1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Namespace Name: unique Namespace:  Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("test.io/namespace-kind:unique"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nPUT /registry/namespaces/unique\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Sequential"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: /v1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Namespace Name: unit-test Namespace:  Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("test.io/namespace-kind:unit-test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nPUT /registry/namespaces/unit-test\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Object"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: /v1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ConfigMap Name: influxdb1 Namespace: unit-test Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("test.io/namespace-kind:unit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Rule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Group:  Resource: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("/v1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ConfigMap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Namespace: unit-test Selector: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("test.io/namespace-kind Exists "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Exclude: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Field: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nPUT /registry/configmaps/unit-test/influxdb1\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Object"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": GVK: /v1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Secret Name: influxdb Namespace: unique Selector: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Matched Rule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Group:  Resource: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("/v1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Secret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Namespace:  Selector: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Exclude: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("/v1, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kind")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Secret exclude-me-secret unique "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Field: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("type NotIn "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("kubernetes.io/service-account-token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nPUT /registry/secrets/unique/influxdb\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("按照"),a("a",{attrs:{href:"https://github.com/etcd-carry/etcd-carry/blob/master/deploy/examples/rules.yaml",target:"_blank",rel:"noopener noreferrer"}},[s._v("rules.yaml"),a("OutboundLink")],1),s._v("里的规则，会有以下资源会被同步过来：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("所有CRD\n命名空间unique\n命名空间unit-test\n命名空间unique下名为influxdb的secret资源\n命名空间unit-test下名为influxdb1的configmap资源\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("在备K8s集群上查看验证，确实如此。")])])}),[],!1,null,null,null);t.default=n.exports}}]);